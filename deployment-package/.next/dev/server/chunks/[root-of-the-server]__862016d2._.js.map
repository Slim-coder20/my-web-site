{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Slim%20Backup/Projets/Dossier%20Professionel%20Studi%202026%20/slim_site_internet/my-web-site/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Slim%20Backup/Projets/Dossier%20Professionel%20Studi%202026%20/slim_site_internet/my-web-site/app/api/stripe/webhook/route.ts"],"sourcesContent":["/**\n * Route API : POST /api/stripe/webhook\n *\n * Cette route re√ßoit les √©v√©nements Stripe via webhook pour mettre √† jour\n * le statut des commandes apr√®s paiement.\n *\n * FLUX DE TRAVAIL :\n * 1. Stripe envoie un √©v√©nement apr√®s chaque action (paiement r√©ussi, √©chou√©, etc.)\n * 2. On v√©rifie la signature du webhook pour s'assurer qu'il vient bien de Stripe\n * 3. Si l'√©v√©nement est \"checkout.session.completed\" (paiement r√©ussi) :\n *    - On retrouve l'Order via le stripeSessionId\n *    - On met √† jour le statut de l'Order √† \"paid\"\n *\n * IMPORTANT : Cette route doit √™tre configur√©e dans le Dashboard Stripe\n * avec l'URL : https://ton-domaine.com/api/stripe/webhook\n * et l'√©v√©nement : checkout.session.completed\n *\n * S√âCURIT√â : La signature du webhook est v√©rifi√©e pour √©viter les requ√™tes frauduleuses.\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport Stripe from \"stripe\";\nimport { prisma } from \"@/lib/prisma\";\nimport { Resend } from \"resend\";\n\n// Initialisation du client Stripe\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: \"2025-10-29.clover\",\n});\n\n// Secret du webhook (r√©cup√©r√© depuis le Dashboard Stripe)\nconst webhookSecret = process.env.STRIPE_WEBHOOK_SECRET!;\n\n// Initialisation du client Resend pour l'envoi d'emails\nconst resend = new Resend(process.env.RESEND_API_KEY);\n\nexport async function POST(request: NextRequest) {\n  console.log(\"üîî Webhook re√ßu !\");\n\n  // R√©cup√©ration du body brut (important pour la v√©rification de signature)\n  const body = await request.text();\n  const signature = request.headers.get(\"stripe-signature\");\n\n  console.log(\"üìù Signature pr√©sente:\", !!signature);\n\n  if (!signature) {\n    console.error(\"‚ùå Pas de signature dans les headers\");\n    return NextResponse.json({ error: \"No signature\" }, { status: 400 });\n  }\n\n  let event: Stripe.Event;\n\n  /**\n   * V√âRIFICATION DE LA SIGNATURE DU WEBHOOK\n   *\n   * Stripe signe chaque webhook avec le secret pour garantir l'authenticit√©.\n   * Si la signature ne correspond pas, cela signifie que la requ√™te\n   * ne vient pas de Stripe et on la rejette.\n   */\n  try {\n    event = stripe.webhooks.constructEvent(body, signature, webhookSecret);\n    console.log(\"‚úÖ Signature v√©rifi√©e, type d'√©v√©nement:\", event.type);\n  } catch (err) {\n    console.error(\"‚ùå Webhook signature verification failed:\", err);\n    return NextResponse.json({ error: \"Invalid signature\" }, { status: 400 });\n  }\n\n  /**\n   * GESTION DE L'√âV√âNEMENT checkout.session.completed\n   *\n   * Cet √©v√©nement est envoy√© par Stripe quand un paiement est compl√©t√© avec succ√®s.\n   * On utilise le stripeSessionId pour retrouver l'Order dans notre base de donn√©es\n   * et mettre √† jour son statut √† \"paid\".\n   */\n  if (event.type === \"checkout.session.completed\") {\n    console.log(\"üí≥ √âv√©nement checkout.session.completed re√ßu\");\n    const session = event.data.object as Stripe.Checkout.Session;\n    console.log(\"üì¶ Session ID:\", session.id);\n\n    try {\n      /**\n       * MISE √Ä JOUR DU STATUT DE L'ORDER\n       *\n       * On retrouve l'Order via le stripeSessionId (qui a √©t√© stock√© lors de la cr√©ation)\n       * et on met √† jour son statut de \"pending\" √† \"paid\".\n       */\n      // V√©rifier d'abord si la commande existe\n      console.log(\n        `üîç Recherche de la commande avec stripeSessionId: ${session.id}`\n      );\n\n      const existingOrder = await prisma.order.findUnique({\n        where: { stripeSessionId: session.id },\n      });\n\n      if (!existingOrder) {\n        // V√©rifier s'il y a des commandes en pending (pour debug)\n        const pendingOrders = await prisma.order.findMany({\n          where: { status: \"pending\" },\n          select: { id: true, stripeSessionId: true, email: true },\n          take: 5,\n        });\n        console.log(`‚ö†Ô∏è  Commande non trouv√©e pour la session: ${session.id}`);\n        console.log(\n          `üìã Commandes en pending trouv√©es: ${pendingOrders.length}`\n        );\n        if (pendingOrders.length > 0) {\n          console.log(\n            `üìã Derni√®res commandes pending:`,\n            pendingOrders.map((o) => ({\n              id: o.id,\n              sessionId: o.stripeSessionId?.substring(0, 20) + \"...\",\n            }))\n          );\n        }\n\n        // Retourner 200 pour ne pas faire √©chouer le webhook\n        // C'est normal pour les √©v√©nements de test qui n'ont pas de commande r√©elle\n        return NextResponse.json({\n          received: true,\n          message: \"Order not found (test event or session mismatch)\",\n        });\n      }\n\n      const updatedOrder = await prisma.order.update({\n        where: { stripeSessionId: session.id },\n        data: { status: \"paid\" },\n        include: {\n          items: {\n            include: {\n              product: true, // Inclure les d√©tails du produit pour l'email\n            },\n          },\n        },\n      });\n\n      console.log(`‚úÖ Order updated to paid for session: ${session.id}`);\n\n      /**\n       * ENVOI DE L'EMAIL DE CONFIRMATION DE COMMANDE\n       *\n       * Apr√®s la mise √† jour du statut √† \"paid\", on envoie un email de confirmation\n       * au client avec les d√©tails de sa commande.\n       */\n      if (process.env.RESEND_API_KEY) {\n        try {\n          // Formatage du montant total\n          const totalAmount = (updatedOrder.amountTotal / 100).toFixed(2);\n\n          // Construction de la liste des produits command√©s\n          const productsList = updatedOrder.items\n            .map(\n              (item) => `\n            <tr>\n              <td style=\"padding: 10px; border-bottom: 1px solid #eee;\">\n                <strong>${item.product.title}</strong>\n              </td>\n              <td style=\"padding: 10px; border-bottom: 1px solid #eee; text-align: center;\">\n                ${item.quantity}\n              </td>\n              <td style=\"padding: 10px; border-bottom: 1px solid #eee; text-align: right;\">\n                ${(item.unitPrice / 100).toFixed(2)} ‚Ç¨\n              </td>\n            </tr>\n          `\n            )\n            .join(\"\");\n\n          // Envoi de l'email de confirmation\n          await resend.emails.send({\n            from: process.env.RESEND_FROM_EMAIL || \"onboarding@resend.dev\",\n            to: updatedOrder.email,\n            subject: \"Confirmation de votre commande - Slim Abida\",\n            html: `\n              <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n                <h2 style=\"color: #333; border-bottom: 2px solid #333; padding-bottom: 10px;\">\n                  Merci pour votre commande !\n                </h2>\n                \n                <p>Bonjour,</p>\n                \n                <p>Nous avons bien re√ßu votre commande et votre paiement a √©t√© confirm√©.</p>\n                \n                <h3 style=\"color: #333; margin-top: 30px;\">D√©tails de votre commande</h3>\n                \n                <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n                  <thead>\n                    <tr style=\"background-color: #f5f5f5;\">\n                      <th style=\"padding: 10px; text-align: left; border-bottom: 2px solid #333;\">Produit</th>\n                      <th style=\"padding: 10px; text-align: center; border-bottom: 2px solid #333;\">Quantit√©</th>\n                      <th style=\"padding: 10px; text-align: right; border-bottom: 2px solid #333;\">Prix</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    ${productsList}\n                  </tbody>\n                  <tfoot>\n                    <tr>\n                      <td colspan=\"2\" style=\"padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #333;\">\n                        Total :\n                      </td>\n                      <td style=\"padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #333;\">\n                        ${totalAmount} ‚Ç¨\n                      </td>\n                    </tr>\n                  </tfoot>\n                </table>\n                \n                <p style=\"margin-top: 30px;\">\n                  Votre commande sera trait√©e dans les plus brefs d√©lais.\n                </p>\n                \n                <p>\n                  Si vous avez des questions, n'h√©sitez pas √† nous contacter.\n                </p>\n                \n                <p style=\"margin-top: 30px; color: #666; font-size: 14px;\">\n                  Cordialement,<br>\n                  L'√©quipe Slim Abida\n                </p>\n              </div>\n            `,\n          });\n\n          console.log(`Confirmation email sent to ${updatedOrder.email}`);\n        } catch (emailError) {\n          // On log l'erreur mais on ne bloque pas le webhook\n          // Le paiement est d√©j√† confirm√©, l'email est secondaire\n          console.error(\"Error sending confirmation email:\", emailError);\n        }\n      }\n    } catch (error) {\n      console.error(\"‚ùå Error updating order:\", error);\n      // Logger plus de d√©tails pour le d√©bogage\n      if (error instanceof Error) {\n        console.error(\"Error message:\", error.message);\n        console.error(\"Error stack:\", error.stack);\n      }\n      // Retourner 200 pour ne pas faire √©chouer le webhook\n      // Stripe r√©essaiera automatiquement si n√©cessaire\n      return NextResponse.json(\n        {\n          error: \"Failed to update order\",\n          details:\n            process.env.NODE_ENV === \"development\"\n              ? error instanceof Error\n                ? error.message\n                : String(error)\n              : undefined,\n        },\n        { status: 200 } // Retourner 200 pour √©viter que Stripe r√©essaie ind√©finiment\n      );\n    }\n  }\n\n  // Retour d'une confirmation √† Stripe\n  console.log(\"‚úÖ Webhook trait√© avec succ√®s\");\n  return NextResponse.json({ received: true });\n}\n"],"names":[],"mappings":"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"}}]
}