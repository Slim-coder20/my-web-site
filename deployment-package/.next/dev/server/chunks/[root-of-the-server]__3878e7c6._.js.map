{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Slim%20Backup/Projets/Dossier%20Professionel%20Studi%202026%20/slim_site_internet/my-web-site/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Slim%20Backup/Projets/Dossier%20Professionel%20Studi%202026%20/slim_site_internet/my-web-site/app/api/stripe/verify-payment/route.ts"],"sourcesContent":["/**\n * Route API : POST /api/stripe/verify-payment\n *\n * Cette route v√©rifie le statut d'un paiement Stripe et met √† jour\n * la commande si le paiement est r√©ussi.\n *\n * UTILISATION :\n * Appel√©e depuis la page de succ√®s apr√®s un paiement Stripe\n * pour v√©rifier et mettre √† jour le statut de la commande.\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport Stripe from \"stripe\";\nimport { prisma } from \"@/lib/prisma\";\nimport { Resend } from \"resend\";\n\n// Initialisation du client Stripe\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: \"2025-10-29.clover\",\n});\n\n// Initialisation du client Resend pour l'envoi d'emails\nconst resend = new Resend(process.env.RESEND_API_KEY);\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { sessionId } = await request.json();\n\n    if (!sessionId) {\n      return NextResponse.json(\n        { error: \"sessionId is required\" },\n        { status: 400 }\n      );\n    }\n\n    console.log(`üîç V√©rification du paiement pour la session: ${sessionId}`);\n\n    // R√©cup√©rer la session Stripe\n    const session = await stripe.checkout.sessions.retrieve(sessionId);\n\n    // V√©rifier si le paiement est r√©ussi\n    if (session.payment_status !== \"paid\") {\n      console.log(`‚ö†Ô∏è  Paiement non compl√©t√© pour la session: ${sessionId}`);\n      return NextResponse.json({\n        status: session.payment_status,\n        message: \"Payment not completed\",\n      });\n    }\n\n    console.log(`‚úÖ Paiement confirm√© pour la session: ${sessionId}`);\n\n    // Rechercher la commande\n    let order = await prisma.order.findUnique({\n      where: { stripeSessionId: sessionId },\n    });\n\n    // Si pas trouv√© par stripeSessionId, essayer avec orderId des m√©tadonn√©es\n    if (!order && session.metadata?.orderId) {\n      console.log(\n        `üîç Commande non trouv√©e par sessionId, recherche par orderId: ${session.metadata.orderId}`\n      );\n      order = await prisma.order.findUnique({\n        where: { id: parseInt(session.metadata.orderId) },\n      });\n\n      // Si trouv√© par orderId, mettre √† jour le stripeSessionId\n      if (order) {\n        await prisma.order.update({\n          where: { id: order.id },\n          data: { stripeSessionId: sessionId },\n        });\n        console.log(\n          `‚úÖ stripeSessionId mis √† jour pour la commande ${order.id}`\n        );\n      }\n    }\n\n    if (!order) {\n      console.log(`‚ö†Ô∏è  Commande non trouv√©e pour la session: ${sessionId}`);\n      return NextResponse.json({\n        error: \"Order not found\",\n      });\n    }\n\n    // Si la commande est d√©j√† pay√©e, ne rien faire\n    if (order.status === \"paid\") {\n      console.log(`‚ÑπÔ∏è  Commande ${order.id} d√©j√† pay√©e`);\n      return NextResponse.json({\n        status: \"paid\",\n        message: \"Order already paid\",\n      });\n    }\n\n    // Mettre √† jour le statut de la commande\n    const updatedOrder = await prisma.order.update({\n      where: { id: order.id },\n      data: { status: \"paid\" },\n      include: {\n        items: {\n          include: {\n            product: true,\n          },\n        },\n      },\n    });\n\n    console.log(`‚úÖ Commande ${order.id} mise √† jour √† \"paid\"`);\n\n    // Envoyer l'email de confirmation\n    if (process.env.RESEND_API_KEY) {\n      try {\n        const totalAmount = (updatedOrder.amountTotal / 100).toFixed(2);\n\n        const productsList = updatedOrder.items\n          .map(\n            (item) => `\n            <tr>\n              <td style=\"padding: 10px; border-bottom: 1px solid #eee;\">\n                <strong>${item.product.title}</strong>\n              </td>\n              <td style=\"padding: 10px; border-bottom: 1px solid #eee; text-align: center;\">\n                ${item.quantity}\n              </td>\n              <td style=\"padding: 10px; border-bottom: 1px solid #eee; text-align: right;\">\n                ${(item.unitPrice / 100).toFixed(2)} ‚Ç¨\n              </td>\n            </tr>\n          `\n          )\n          .join(\"\");\n\n        await resend.emails.send({\n          from: process.env.RESEND_FROM_EMAIL || \"onboarding@resend.dev\",\n          to: updatedOrder.email,\n          subject: \"Confirmation de votre commande - Slim Abida\",\n          html: `\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n              <h2 style=\"color: #333; border-bottom: 2px solid #333; padding-bottom: 10px;\">\n                Merci pour votre commande !\n              </h2>\n\n              <p>Bonjour,</p>\n\n              <p>Nous avons bien re√ßu votre commande et votre paiement a √©t√© confirm√©.</p>\n\n              <h3 style=\"color: #333; margin-top: 30px;\">D√©tails de votre commande</h3>\n\n              <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n                <thead>\n                  <tr style=\"background-color: #f5f5f5;\">\n                    <th style=\"padding: 10px; text-align: left; border-bottom: 2px solid #333;\">Produit</th>\n                    <th style=\"padding: 10px; text-align: center; border-bottom: 2px solid #333;\">Quantit√©</th>\n                    <th style=\"padding: 10px; text-align: right; border-bottom: 2px solid #333;\">Prix</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${productsList}\n                </tbody>\n                <tfoot>\n                  <tr>\n                    <td colspan=\"2\" style=\"padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #333;\">\n                      Total :\n                    </td>\n                    <td style=\"padding: 10px; text-align: right; font-weight: bold; border-top: 2px solid #333;\">\n                      ${totalAmount} ‚Ç¨\n                    </td>\n                  </tr>\n                </tfoot>\n              </table>\n\n              <p style=\"margin-top: 30px;\">\n                Votre commande sera trait√©e dans les plus brefs d√©lais.\n              </p>\n\n              <p>\n                Si vous avez des questions, n'h√©sitez pas √† nous contacter.\n              </p>\n\n              <p style=\"margin-top: 30px; color: #666; font-size: 14px;\">\n                Cordialement,<br>\n                L'√©quipe Slim Abida\n              </p>\n            </div>\n          `,\n        });\n\n        console.log(`‚úÖ Email de confirmation envoy√© √† ${updatedOrder.email}`);\n      } catch (emailError) {\n        console.error(\"‚ùå Erreur lors de l'envoi de l'email:\", emailError);\n      }\n    }\n\n    return NextResponse.json({\n      status: \"paid\",\n      message: \"Order updated successfully\",\n      orderId: updatedOrder.id,\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la v√©rification du paiement:\", error);\n    return NextResponse.json(\n      {\n        error: \"Failed to verify payment\",\n        details:\n          process.env.NODE_ENV === \"development\"\n            ? error instanceof Error\n              ? error.message\n              : String(error)\n            : undefined,\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}